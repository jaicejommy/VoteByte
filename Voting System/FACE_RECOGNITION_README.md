# Face Recognition Implementation for VoteByte

This document describes the face recognition system implemented for the voting application, enabling secure face-based verification during signup and voting.

## Overview

The system uses **face-api.js** (powered by TensorFlow.js) to:
1. **Capture face during signup** - Store user's face photo and descriptor
2. **Verify face during voting** - Compare live face with registered face to ensure only authorized users can vote

## Architecture

### Frontend Components

#### 1. **FaceCapture.jsx** - Signup Face Capture
- **Location**: `frontend/src/components/FaceCapture.jsx`
- **Purpose**: Captures user's face during registration
- **Features**:
  - Real-time face detection using face-api.js
  - Automatic face quality detection
  - Stores face photo and descriptor vector
  - Visual feedback for successful capture
  - Ability to retake photos

**Usage in SignUpPage.jsx**:
```jsx
<FaceCapture 
  onCapture={(data) => {
    setFaceData(data);
    setShowFaceCapture(false);
  }}
  theme={theme}
/>
```

#### 2. **FaceVerification.jsx** - Voting Face Verification
- **Location**: `frontend/src/components/FaceVerification.jsx`
- **Purpose**: Verifies face during voting process
- **Features**:
  - Modal-based verification interface
  - Real-time face detection feedback
  - Sends face descriptor to backend for verification
  - Shows verification result (success/failure with distance metric)
  - Can retry if verification fails

**Usage in ActiveElection.jsx**:
```jsx
<FaceVerification
  onVerify={handleFaceVerified}
  onCancel={() => setShowFaceVerification(false)}
/>
```

### Backend Services

#### 1. **faceRecognitionService.js** - Face Recognition Logic
- **Location**: `backend/services/faceRecognitionService.js`
- **Key Functions**:

##### `storeFacePhoto(userId, faceImageBuffer, faceDescriptor)`
- Uploads face photo to Cloudinary
- Stores face descriptor locally in `backend/face_storage/`
- Returns: `{ facePhotoUrl, descriptorPath }`

##### `verifyFace(userId, currentFaceDescriptor, matchThreshold = 0.6)`
- Retrieves stored face descriptor for user
- Compares current face with stored face using Euclidean distance
- Returns: `{ verified: boolean, distance: number, message: string }`
- **Threshold**: 0.6 (lower values = stricter matching)

##### `compareFaceDescriptors(descriptor1, descriptor2, threshold)`
- Calculates Euclidean distance between two face descriptors
- Returns true if distance < threshold

**Face Descriptors**:
- 128-dimensional vectors (Float32Array) representing face features
- Generated by face-api.js using face recognition model
- Stored locally as JSON for comparison during verification

#### 2. **faceVerificationController.js** - API Endpoints
- **Location**: `backend/controllers/faceVerificationController.js`

##### Endpoint: `POST /api/votes/verify-face`
- **Purpose**: Verify face for voting
- **Authentication**: Required
- **Body**: 
```json
{
  "face_descriptor": [0.1234, 0.5678, ...]
}
```
- **Response**:
```json
{
  "verified": true,
  "distance": 0.4523,
  "message": "Face verified successfully"
}
```

##### Endpoint: `POST /api/votes/face-verify/:electionId`
- **Purpose**: Verify face and mark voter as face-verified in database
- **Authentication**: Required
- **Parameters**: `electionId`
- **Body**: 
```json
{
  "face_descriptor": [0.1234, 0.5678, ...]
}
```
- **Response**:
```json
{
  "success": true,
  "message": "Face verified successfully",
  "face_verified": true,
  "distance": 0.4523
}
```

### Integration Points

#### 1. **Signup Flow**
```
User Registration → Face Capture → Store Face Photo + Descriptor → Complete Signup
```

**Files Modified**:
- `frontend/src/pages/SignUpPage.jsx` - Added FaceCapture component
- `backend/controllers/authController.js` - Handle face data during registration
- `backend/services/faceRecognitionService.js` - Store face data

#### 2. **Voting Flow**
```
Start Voting → Face Verification Modal → Capture Face → Compare with Stored → 
If Match → Allow Vote → Cast Vote | If No Match → Show Error → Retry
```

**Files Modified**:
- `frontend/src/pages/ActiveElection.jsx` - Trigger FaceVerification before voting
- `backend/services/voteService.js` - Check `face_verified` flag before allowing vote
- `backend/routes/vote.js` - Added face verification endpoints
- `backend/controllers/faceVerificationController.js` - Handle face verification logic

## Database Schema

### User Table Additions (Not Yet Implemented)
If you decide to store face data in database later:
```prisma
model User {
  // ... existing fields
  face_photo    String?  // URL to stored face photo
  face_vector   String?  // Serialized face descriptor
}
```

### Voter Table Additions (Not Yet Implemented)
```prisma
model Voter {
  // ... existing fields
  face_verified Boolean @default(false)  // Face verification status for voting
}
```

## File Storage Structure

### Face Storage Directory
```
backend/face_storage/
├── {userId}_descriptor.json  (Face descriptor for user)
├── {userId}_descriptor.json
└── ...
```

### Example Descriptor File
```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "descriptor": [0.123, 0.456, 0.789, ...],
  "storedAt": "2025-11-13T10:30:00.000Z"
}
```

## Face Detection Models

The implementation uses pre-trained models from **face-api.js**:

1. **TinyFaceDetector** - Lightweight face detection
2. **FaceLandmark68Net** - 68 facial landmarks
3. **FaceRecognitionNet** - Face descriptor generation (128D vector)

Models are loaded from CDN:
```
https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js
```

## Configuration

### Face Matching Threshold
- **Current**: 0.6
- **Location**: `backend/services/faceRecognitionService.js` and `faceVerificationController.js`
- **Adjustment**: Lower values = stricter matching (more false negatives), Higher values = lenient matching (more false positives)

### Recommended Values
- `0.4` - Very strict (high false rejection rate)
- `0.6` - Balanced (recommended)
- `0.8` - Lenient (high false acceptance rate)

## Security Considerations

1. **Face Photo Storage**: Stored in Cloudinary with access control
2. **Face Descriptor Storage**: Stored locally on server (can be encrypted)
3. **Face Verification**: One-way comparison (can't reverse descriptor to image)
4. **Session Security**: Uses JWT authentication middleware
5. **HTTPS**: Required in production for secure transmission

## Error Handling

### Common Errors

1. **"No face detected"**
   - Solution: Ensure good lighting, clear visibility of face, remove obstructions

2. **"Face verification failed"**
   - Reason: Captured face doesn't match stored face
   - Solution: Retake photo, ensure same person, similar angles/lighting

3. **"Face detection models failed to load"**
   - Reason: CDN unreachable or network issue
   - Solution: Check internet connection, verify CDN availability

4. **"Descriptor length mismatch"**
   - Reason: Invalid face descriptor format
   - Solution: Ensure descriptor is 128-dimensional array

## Performance Optimization

1. **Model Loading**: Cache models in browser localStorage (future enhancement)
2. **Face Detection**: Uses TinyFaceDetector for faster detection
3. **Descriptor Comparison**: O(n) Euclidean distance calculation
4. **Photo Upload**: Uses Cloudinary for CDN distribution

## Testing

### Test Cases

1. **Signup with Face Capture**
   ```
   Register → Capture face → Verify face stored → Complete signup
   ```

2. **Voting with Face Verification**
   ```
   Start voting → Trigger face verification → Compare face → Cast vote
   ```

3. **Face Mismatch**
   ```
   Stored different person's face → Try to vote → Verification fails → Retry
   ```

4. **Error Scenarios**
   ```
   No camera access → No face detected → Network error
   ```

## Future Enhancements

1. **Database Storage**: Store face_vector in database
2. **Liveness Detection**: Detect if face is real (anti-spoofing)
3. **Multiple Face Registration**: Store multiple angles of user's face
4. **Face Recognition Analytics**: Track verification success/failure rates
5. **Privacy Controls**: Allow users to delete face data
6. **Encryption**: Encrypt face descriptors at rest
7. **Audit Logging**: Log all face verification attempts

## Dependencies

### Frontend
- `face-api.js` - Face detection and recognition (loaded from CDN)
- `@tensorflow/tfjs` - TensorFlow.js (used by face-api)
- `@tensorflow/tfjs-backend-webgl` - WebGL backend

### Backend
- `cloudinary` - Face photo storage
- Existing dependencies (express, prisma, multer)

## Deployment Notes

1. **Models Directory**: Ensure `/public/face-models/` exists and is readable
2. **Cloudinary Setup**: Configure Cloudinary credentials in `.env`
3. **Face Storage Directory**: `/backend/face_storage/` will be created automatically
4. **CORS**: Ensure face API CDN is whitelisted in CORS configuration
5. **File Permissions**: Ensure write permissions for face_storage directory

## Troubleshooting

### Camera Not Working
```
- Check browser permissions
- Use HTTPS (required for camera access)
- Try different browser
- Check camera hardware
```

### Face Not Detected
```
- Ensure good lighting
- Face should be clearly visible
- Remove obstructions (masks, sunglasses, hat)
- Move closer to camera
- Adjust camera angle
```

### Verification Always Fails
```
- Same person registered and verifying?
- Similar lighting conditions?
- Threshold too strict (0.6)?
- Try with threshold 0.7 or 0.8
```

## API Reference

### Backend Routes

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/votes/verify-face` | Yes | Verify face for voting |
| POST | `/api/votes/face-verify/:electionId` | Yes | Verify and mark as verified |
| POST | `/api/votes/cast` | Yes | Cast vote (requires face_verified) |
| GET | `/api/votes/voter-status/:electionId` | Yes | Get voter status |

## Support

For issues or questions, refer to:
- face-api.js docs: https://github.com/vladmandic/face-api
- TensorFlow.js: https://www.tensorflow.org/js
- Project repository: [Your repo URL]
